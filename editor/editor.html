<!DOCTYPE html>

<head>
<link rel="stylesheet" href="editor.css" type="text/css">
</head>
<h1>Bitmap font editor</h1>

<div id="panel">
  <!-- <div class="subpanel">
    <h3>font size</h3>
    w <select id="select-width"></select>
    h <select id="select-height"></select>
  </div> -->

  <div class="subpanel">
    <h3>editor</h3>
        <!-- choose font: <select></select> --> <button class="download-button">download .json</button>
    <div id="font-editor">
    </div>
  </div>
</div>
<script src="../lib/jquery-1.6.1.min.js"></script>
<script src="../lib/jsparse.js"></script>
<script src="../lib/utils.js"></script>
<script src="js/font.js"></script>
<script src="js/parser.js"></script> 
<script src="js/font_utils.js"></script>

<script>
var pixel_size = 16;

var $editor = $("#font-editor");

// init font size selectors
var $selectWidth = $("#select-width");
var $selectHeight = $("#select-height");
var $canvases = $("canvas");

var MAX_SIZE = 48;
var DEFAULT_SIZE = 8;

// init width/height dropdowns
for (var s=1 ; s<MAX_SIZE ; s++ )
{
  var option = $("<option>"+s+"</option>");
  if (s==DEFAULT_SIZE)
    option.attr("selected", "selected");
  $selectWidth.append(option);
  
  option = $("<option>"+s+"</option>");
  if (s==DEFAULT_SIZE)
    option.attr("selected", "selected");
  $selectHeight.append(option);
}

function FontEditor($element, font)
{
  // console.log("font:", font);
  for(var g in font.glyphs)
  {
    var glyph = font.glyphs[g];
    var $canvas = $("<canvas>");
    var canvas = $canvas[0];
    canvas.width = glyph.width();
    canvas.height = glyph.height();
    $canvas
      .attr("id" , g)
      .addClass("glyph-editor");
    
    var $wrapper = $("<div>").css( { 
      width : glyph.width()*pixel_size + 40 ,
      display: "inline-block"
    });
    
    var $encoding = $("<div>").text(String.fromCharCode(g));
    $wrapper.append($encoding);
    $wrapper.append($canvas);
    
    $element.append($wrapper);
    
    draw(glyph, canvas);
    init(glyph, canvas);
  }
}

function draw(glyph, canvas) {
  var ctx = canvas.getContext("2d");
  ctx.clearRect(0,0, glyph.width(), glyph.height());
  ctx.strokeStyle = "white";
  ctx.fillStyle = "black";
  canvas.width = glyph.width() * pixel_size;
  canvas.height = glyph.height() * pixel_size;

  for(var y=0 ; y<glyph.height() ; y++)
  for(var x=0 ; x<glyph.width() ; x++)
  {
    // console.log(x,y,sprite[y][x]);
    // sprite
    if (glyph.get(x,y))
      ctx.fillRect(x*pixel_size, y*pixel_size, pixel_size, pixel_size);
      
    // grid
    ctx.strokeRect(x*pixel_size, y*pixel_size, pixel_size, pixel_size);
  }
}


function init(glyph, canvas) {
  var $canvas = $(canvas);
  $canvas.click(function(e) { 

    // get coords relative to the canvas top/left corner
    var x = e.pageX - $canvas.offset().left;
    var y = e.pageY - $canvas.offset().top;

    // calc which pixel in the glyph that is
    x = Math.floor(x / pixel_size);
    y = Math.floor(y / pixel_size);

    // toggle pixel
    var oldValue = glyph.get(x,y);
    //console.log(oldValue);
    if (oldValue)
      glyph.set(x,y, 0);
    else
      glyph.set(x,y, 1);

    draw(glyph, canvas); 
  });
}

function string_array() {
  var result = [];
  
  for(var y=0 ; y<sprite_height ; y++)
  {
    var row = "";
    
    for(var x=0 ; x<sprite_width ; x++)
      row +=sprite[y][x] ? "*" : " ";
    
    result.push(row);
  }
  
  //console.log(result);
  return result;
}

//function updateSize() {
//  sprite_width = +$("#select-width").val();
//  width = canvas.width = sprite_width * pixel_size;

//  sprite_height = +$("#select-height").val();
//  height = canvas.height = sprite_height * pixel_size;
//  
//  console.log("setting size to: " + sprite_width + " x " + sprite_height);
//  
//  $("#panel").css({ width: width + "px" });

//  sprite = [];
//  for(var s=0 ; s<sprite_height ; s++)
//    sprite.push([]);
//}

//$selectHeight.change(function (e) { 
//  updateSize();
//  draw();
//});

//$selectWidth.change(function (e) { 
//  updateSize();
//  draw();
//});
//"fonts/c64.bdf"
LoadFont(querystring("file"), function(f) {
  font = f;
  var editor = new FontEditor($editor, f);
});

// FIXME: use downloadify
$(".download-button").click(function() {
  if (!font)
    throw new Error('no font loaded!');
  document.location = "data:application/octet-stream;base64," + btoa(JSON.stringify(font));
});

</script>